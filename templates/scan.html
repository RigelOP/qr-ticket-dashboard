<!DOCTYPE html>
<html>
<head>
    <title>Scan QR Code</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="container py-5">
    <h2>Scan QR Code</h2>
    <a href="{{ url_for('home') }}" class="btn btn-secondary mb-3">Back to Home</a>
    <div id="reader" style="width:300px"></div>
    <div id="result" class="mt-4"></div>
    <script>
        function showResult(message, isValid, name, qr_content) {
            let html = '';
            html += `<div class="alert ${isValid ? 'alert-success' : 'alert-danger'}"><b>${message}</b></div>`;
            html += `<div class="mt-2"><b>QR Content:</b> <pre>${qr_content}</pre></div>`;
            html += `<button class="btn btn-primary mt-3" onclick="restartScan()">Back to Scan</button>`;
            document.getElementById('result').innerHTML = html;
        }

        function restartScan() {
            document.getElementById('result').innerHTML = '';
            html5QrcodeScanner.clear().then(() => {
                html5QrcodeScanner.render(onScanSuccess);
            });
        }

        function onScanSuccess(decodedText, decodedResult) {
            html5QrcodeScanner.clear();
            fetch("{{ url_for('verify_qr') }}", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({qr_content: decodedText})
            })
            .then(response => response.json())
            .then(data => {
                showResult(
                    data.message,
                    data.message.startsWith("âœ…"),
                    data.name || "",
                    data.qr_content || decodedText
                );
            })
            .catch(() => {
                showResult("Could not verify QR code.", false, "", decodedText);
            });
        }

        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess);
    </script>
</body>
</html>